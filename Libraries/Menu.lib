settings: ;settings
	if FirstRun
		GoSub Initiation

	Width := 280
	labelsx := (Width/7)
	inputw := (Width/2)
	lpwwidth:=56
	lpwpos:=(inputw/2)-(lpwwidth/2)+18

	IniRead, seconds, settings.ini, settings, seconds
	IniRead, email, settings.ini, settings, email
	IniRead, passwordhash, settings.ini, settings, passwordhash
	password:=Crypt.Encrypt.StrDecrypt(passwordhash,"KktgC3l0wR",7,3)

	Gui, settings:New, +hwndScriptOptions
	Gui, +LastFound
	WinSet, Transparent, 0
	Gui, Margin, 0, 0
	Gui, Font, s10 cFFFFFF Bold, Segoe UI
	Gui, Add, Progress, % "x-1 y-1 w" (Width+2) " h31 Background1F2326 Disabled hwndHPROG"
	Control, ExStyle, -0x20000, , ahk_id %HPROG% ; propably only needed on Win XP
	Gui, Add, Text, % "x0 y8 w" Width " r1 BackgroundTrans Center 0x200 gGuiMove cD0D0D0", Script Options

		Gui, Color, 008383, 252525
		Gui, Font, s9
		Gui, Font, normal

	Gui, Add, Text, % "x" labelsx " y+18", Start with Windows
	Gui, Add, DropDownList, % "x" Width-105 " w75 y40 Center vStartWithWindows 0x200 Choose" StartWithWindows " AltSubmit" , No|Yes

	Gui, Add, Text, % "x0 y+14 w" width " Center", Optional:
	Gui, Font, s9 cDFDFDF
	Gui, Add, Text, % "x0 y+3 w" width " Center", (Use keys to output anywhere)
	Gui, Font, s9 cFFFFFF

	Gui, Add, Text, % "x" labelsx " y+12", Email:
	Gui, Add, Edit, % "x+38 w" inputw " h15 hwndEdit6 vemail -E0x200 +Center -VScroll", %email%
	SetEditCueBanner(Edit6, "CapsLock x2")
	Gui, Add, Text, % "x" labelsx " y+10", Password:
	Gui, Add, Edit, % "x+17 w" inputw " h15 hwndEdit7 vpassword +password -E0x200 +Center -VScroll", %password%
	SetEditCueBanner(Edit7, "Win + CapsLock x2")


	Gui, Font, s10 w600
	Opt1 := [6, 0x008383, 0x008383, "White"]
	Opt2 := [ , 0x008383, 0x00a3a3, 0xffffff]
	Opt4 := [0, 0xC0A0A0A0, , 0xC0606000]

	Gui, Add, Button, % "x" (Width/2)-((Width*0.80)/2) " y+19 w" (Width*0.80) " gProtectionSettings h37 hwndBut1 +Center", Protection Settings

	Gui, Add, Button, % "x" (Width/2)-((Width*0.80)/2) " y+0 w" (Width*0.80) " h37 gOtherSettingsLabel hwndBut2 +Center", Other Settings

	Gui, Add, Button, % "x" (Width/2)-((Width*0.80)/2) " y+0 w" (Width*0.80) " h37 gScriptFunctions hwndBut3 +Center", Controls

	Gui, Add, Button, % "x" (Width/2)-((Width*0.80)/2) " y+0 w" (Width*0.80) " h37 gmnuUninstall hwndBut4 +Center", Uninstall

	Gui, Font, s9
	Gui, Font, normal

	Gui, Font, s10 cFFFFFF Bold, Segoe UI
	Gui, Add, Button, % "x" (Width/2)-(Width*0.30)-2 " y+15 w" (Width*0.30) " gbutton hwndBut5 +Center +Default", Apply

	Gui, Add, Button, % "x+5 w" (Width*0.30) " gdestroyset hwndBut6 +Center",Cancel

	Gui, Add, Text, % "x+1 h42 vP"
	GuiControlGet, P, Pos
	H := PY + PH
	H:=H*dpi
	Width:=Width*dpi
	ImageButton.Create(But1, Opt1, Opt2, "", Opt4)
	ImageButton.Create(But2, Opt1, Opt2, "", Opt4)
	ImageButton.Create(But3, Opt1, Opt2, "", Opt4)
	ImageButton.Create(But4, Opt1, Opt2, "", Opt4)
	ImageButton.Create(But5, Opt1, Opt2, "", Opt4)
	ImageButton.Create(But6, Opt1, Opt2, "", Opt4)
	Gui, -Caption
	WinSet, Region, 0-0 w%Width% h%H% r6-6
	Gui, Show, % "w" Width , Script Options
	FadeIn(ScriptOptions)
return

button:
	Gui, Submit, NoHide

	passwordhash:=Crypt.Encrypt.StrEncrypt(password,"KktgC3l0wR",7,3)
	IniWrite, %passwordhash%, settings.ini, settings, passwordhash
	IniWrite, %email%, settings.ini, settings, email
	IniWrite, %StartWithWindows%, settings.ini, settings, StartWithWindows
	idleseconds:=1000*(seconds)
	FadeOut(ScriptOptions)
	RSNotify("Applied")
	SplitPath, A_Scriptname, , , , OutNameNoExt
	LinkFile=%A_Startup%\%OutNameNoExt%.lnk
	StartMenuFile=%A_StartMenu%\Programs\devRS.lnk
	If StartWithWindows=2
	{
		If A_IsCompiled=1
		{
			IfNotExist, %LinkFile%
			FileCreateShortcut, %A_ScriptFullPath%, %LinkFile%
			IfNotExist, %StartMenuFile%
			FileCreateShortcut, %A_ScriptFullPath%, %StartMenuFile%
			If FirstRun
				IniWrite, 1, settings.ini, settings, CreateATask
			else
				Run, %comspec% /c SchTasks /SC ONLOGON /F /Create /TN RSRunScript /RL HIGHEST /TR "%A_ScriptDir%\launcher.exe, , HIDE
		}
	}
	If StartWithWindows=1
	{
		FileDelete, %LinkFile%
		Run, %comspec% /c SchTasks /F /Delete /TN RSRunScript, , HIDE
	}
	If FirstRun
	{
		SetTimer, ARun, -1600
		FirstRun:=false
	}
return

destroyset:
	If FirstRun
	{
		RSNotify("Careful, no settings!")
		SetTimer, ARun, -1600
	}
	FirstRun:=false
	FadeOut(ScriptOptions)
return

;--------------------------------------------------------------------------------------------------------------

OtherSettingsLabel:
	Width := 255
	labelsx := (Width/7)+30
	inputw := (Width/2)
	lpwwidth:=56
	lpwpos:=(inputw/2)-(lpwwidth/2)+18

	IniRead, TransparentStartMenu, settings.ini, settings, TransparentStartMenu
	taskbarsave=%TransparentStartMenu%
	SetTimer, KeepTrans, Off

	Gui, OtherMenu:New, +hwndOtherHWND
	Gui, +LastFound
	WinSet, Transparent, 0
	Gui, Margin, 0, 0
	Gui, Font, s9 cFFFFFF Bold, Tahoma
	Gui, Add, Progress, % "x-1 y-1 w" (Width+2) " h31 Background1F2326 Disabled hwndHPROG"
	Control, ExStyle, -0x20000, , ahk_id %HPROG% ; propably only needed on Win XP
	Gui, Add, Text, % "x0 y8 w" Width " r1 BackgroundTrans Center 0x200 gGuiMove cD0D0D0", Other Settings

	Gui, Color, 008383, 333333
	Gui, Font, s8, Tahoma
	Gui, Font, normal

	Gui, Add, Text, % "x20 y+30 w120 Center", Hotkeys in Fullscreen ›
	Gui, Add, DropDownList, % "x+15 w65 Center vSuspendFS Choose" SuspendFS " AltSubmit" , Yes|No

	IfExist, *.ahk
	{
		Gui, Add, Text, % "x0 y+25 w" Width " Center", -   Extensions   -
		Loop, Files, *.ahk
		{
			SplitPath, A_LoopFileLongPath,,,, PluginName
			IniRead, PluginState, settings.ini, plugins, PluginState%PluginName%, 1
			Gui, Add, Text, % "x15 y+15 w120 Center", %PluginName% ›
			Gui, Add, DropDownList, % "x+20 w65 Center vPluginState" PluginName " Choose" PluginState " AltSubmit" , On|Off|Delete
		}
	}

	Gui, Add, Text, % "x0 w" Width " y+30 Center", Taskbar Transparency:
	Gui, Add, Slider, % "x40 w" Width-80 " h45 Range0-255 y+15 hwndEdit8 vTransparentStartMenu gTaskbarSet Thick19 -Theme +Center", %TransparentStartMenu%

	Gui, Font, s10 cFFFFFF Bold, Segoe UI
	Opt1 := [6, 0x008383, 0x008383, "White"]
	Opt2 := [ , 0x008383, 0x00a3a3, 0xffffff]
	Opt4 := [0, 0xC0A0A0A0, , 0xC0606000]

	Gui, Add, Button, % "x" (Width/2)-(Width*0.30)-2 " y+15 w" (Width*0.30) " gotherbutton hwndBut1 +Center +Default", Apply

	Gui, Add, Button, % "x+5 w" (Width*0.30) " gotherclose hwndBut2 +Center",Cancel

	Gui, Add, Text, % "x+1 h42 vP"
	GuiControlGet, P, Pos
	H := PY + PH
	H:=H*dpi
	Width:=Width*dpi
	ImageButton.Create(But1, Opt1, Opt2, "", Opt4)
	ImageButton.Create(But2, Opt1, Opt2, "", Opt4)
	Gui, -Caption
	WinSet, Region, 0-0 w%Width% h%H% r6-6
	Gui, Show, w%Width%, Other Settings
	FadeIn(OtherHWND)
return

otherbutton:
	Gui, Submit, NoHide

	If(TransparentStartMenu<12)
	{
		If !Tried
		{
		Warning:="Careful!"
		Warning2:="The taskbar will be invisible."
		GoSub WarningGUI
		Tried:=true
		return
		}
		else
		{
			Warning:="Don't say I didn't warn you!"
			GoSub WarningGUI
		}
	}

	Tried:=false
	IniWrite, %TransparentStartMenu%, settings.ini, settings, TransparentStartMenu
	IniWrite, %SuspendFS%, settings.ini, settings, SuspendFS
	SetTimer, KeepTrans, 12000

	IfExist, *.ahk
	{
		Loop, Files, *.ahk
		{
			SplitPath, A_LoopFileLongPath,,,, PluginName
			If % PluginState%PluginName%=1
			{
				IniWrite, % PluginState%PluginName%, settings.ini, plugins, PluginState%PluginName%
				Run, %A_MyDocuments%\%ScriptName%\Extensions %A_LoopFileLongPath%,,, PID%PluginName% ; PluginID is the PID for the process. Required when you need to close/uninstall the program.
			}
			else if % PluginState%PluginName%=2
			{
				IniWrite, % PluginState%PluginName%, settings.ini, plugins, PluginState%PluginName%
				IfWinExist, % "ahk_pid" PID%PluginName%
					WinKill, % "ahk_pid" PID%PluginName%
			}
			else if % PluginState%PluginName%=3
			{
				IniDelete, settings.ini, plugins, PluginState%PluginName%
				IfWinExist, % "ahk_pid" PID%PluginName%
					WinKill, % "ahk_pid" PID%PluginName%
				FileDelete, %PluginName%.ahk
			}
			}
		}
	FadeOut(OtherHWND)
return

otherclose:
WinSet, Transparent, %taskbarsave%, ahk_class Shell_TrayWnd
FadeOut(OtherHWND)
return
destroy:
	FadeOut(ScriptOptions)
return

;--------------------------------------------------------------------------------------------------------------

ProtectionSettings:
	IniWrite, %keysvar%, settings.ini, settings, lockkey
	IniRead, lockkey, settings.ini, settings, lockkey
	IniRead, BreakLoop, settings.ini, settings, BreakLoop
	IniRead, seconds, settings.ini, settings, seconds
	IniRead, ClockWanted, settings.ini, settings, ClockWanted, 0
	IniRead, AfterFS, settings.ini, settings, AfterFS
	IniRead, AfterWU, settings.ini, settings, AfterWU
	IniRead, logging, settings.ini, settings, LoggingLockTimes

	If LockPw
		AuthPassword=%LockPw%
	else
		AuthPassword:=false

	If BreakLoop=1
	ChooseBL=1
	Else
	ChooseBL=2

	Width := 295
	Gui, ProtectionMenu:New, +hwndProtectionSettings
	Gui, +LastFound
	WinSet, Transparent, 0
	Gui, Color, 808080
	Gui, Margin, 0, 0
	Gui, Font, s9 cFFFFFF Bold, Tahoma
	Gui, Add, Progress, % "x-1 y-1 w" (Width+2) " h31 Background1F2326 Disabled hwndHPROG"
	Control, ExStyle, -0x20000, , ahk_id %HPROG% ; propably only needed on Win XP
	Gui, Add, Text, % "x0 y8 w" Width " r1 BackgroundTrans Center 0x200 gGuiMove cD0D0D0", Protection Settings
		Gui, Color, 008383, 333333
		Gui, Font, s8, Tahoma
		Gui, Font, normal
	Gui, Add, Text, % "x8 y+25 w147 Center", Computer ›

	Gui, Add, DropDownList, % "x+8 w87 Center vBreakLoop Choose" ChooseBL " AltSubmit" , Protected|Unprotected

	Gui, Add, Text, % "x8 y+22 w147 Center", Protection PIN ›
	Gui, Add, Edit, % "x+8 w87 h15 vLockPw hwndEdit8 +password -E0x200 +Center -VScroll", %LockPw%

	Gui, Add, Text, % "x8 y+13 w147 Center", Seconds until lock ›
	Gui, Add, Edit, % "x+8 w87 h15 hwndEdit1 vseconds -E0x200 +Center -VScroll", %seconds%

	Gui, Add, Text, % "x8 y+22 w147 Center", Lock After Full Screen ›
	Gui, Add, DropDownList, % "x+8 w87 Center vAfterFS Choose" AfterFS " AltSubmit" , On|Off

	Gui, Add, Text, % "x8 y+14 w147 Center", Lock After Wake Up ›
	Gui, Add, DropDownList, % "x+8 w87 Center vAfterWU Choose" AfterWU " AltSubmit" , On|Off

	Gui, Add, Text, % "x8 y+14 w147 Center", Security Logs ›
	Gui, Add, DropDownList, % "x+8 w87 Center vlogging Choose" logging " AltSubmit" , On|Off

	Gui, Add, Text, % "x8 y+14 w147 Center", Clock ›
	Gui, Add, DropDownList, % "x+8 w87 Center vClockWanted Choose" ClockWanted " AltSubmit" , On|Off
	Gui, Add, Text, % "x8 y+14 w147 Center", Key ›
	Gui, Add, Hotkey, % "x+8 w87 Center vKeysVar" , %lockkey%
	Gui, Font, s10 cFFFFFF Bold, Segoe UI
	Opt1 := [6, 0x008383, 0x008383, "White"]
	Opt2 := [ , 0x008383, 0x00a3a3, 0xffffff]
	Opt4 := [0, 0xC0A0A0A0, , 0xC0606000]

	Gui, Add, Button, % "x" (Width/2)-((Width*0.64)/2) " y+22 w" (Width*0.64) " h37 gPrInfo hwndBut1 +Center", Info

	If(logging=1)
	{
		Gui, Add, Button, % "x" (Width/2)-((Width*0.64)/2) " y+9 w" (Width*0.64) " h37 gSecurityLoggingLabel hwndBut2 +Center", Show Logs
		ImageButton.Create(But2, Opt1, Opt2, "", Opt4)
	}

	Gui, Add, Button, % "x" (Width/2)-(Width*0.30)-2 " y+15 w" (Width*0.30) " gprotectionbutton hwndBut3 +Center +Default", Apply

	Gui, Add, Button, % "x+5 w" (Width*0.30) " gdestroyprot hwndBut4 +Center",Cancel

	Gui, Add, Text, % "x+1 h46 vP"
	GuiControlGet, P, Pos
	H := PY + PH
	H:=H*dpi
	Width:=Width*dpi
	ImageButton.Create(But1, Opt1, Opt2, "", Opt4)
	ImageButton.Create(But3, Opt1, Opt2, "", Opt4)
	ImageButton.Create(But4, Opt1, Opt2, "", Opt4)
	Gui, -Caption
	WinSet, Region, 0-0 w%Width% h%H% r6-6
	Gui, Show, % "w295" , RS-Guard Settings
	FadeIn(ProtectionSettings)
return

destroyprot:
FadeOut(ProtectionSettings)
return

protectionbutton:
	Gui, Submit, NoHide

	MetRequirements:=True
	If BreakLoop=1
	{
		If !LockPw
		{
			Warning:="A password is needed."
			GoSub WarningGUI
			MetRequirements:=False
		}
		Else If LockPw is not digit
		{
			Warning:="Password needs to be a number."
			GoSub WarningGUI
			MetRequirements:=False
		}
		Else If seconds=0
		{
			Warning:="Seconds need to be higher than 0."
			GoSub WarningGUI
			MetRequirements:=False
		}
		Else If seconds=""
		{
			Warning:="Please input seconds."
			GoSub WarningGUI
			MetRequirements:=False
		}
		Else If seconds is not number
		{
			Warning:="Seconds need to be a number."
			GoSub WarningGUI
			MetRequirements:=False
		}
		If(MetRequirements=0)
		{
			BreakLoop=0
			return
		}
	}
	NewLockPw:=LockPw
	LockPw:=AuthPassword
	If (NewLockPw!=AuthPassword) && AuthPassword
	{
		DontShowRS:=true
		AuthReq:=true
		GoSub LockNow
		WinWaitActive, ahk_id %ZPHWND%
		WinWaitNotActive, ahk_id %ZPHWND%
	}
	LockPw:=NewLockPw

	LockPwHash:=Crypt.Encrypt.StrEncrypt(LockPw,"KktgC3l0wR",7,3)
	IniWrite, %LockPwHash%, settings.ini, settings, LockPwHash
	IniWrite, %KeysVar%, settings.ini, settings, lockkey
	IniWrite, %BreakLoop%, settings.ini, settings, breakloop
	IniWrite, %ClockWanted%, settings.ini, settings, ClockWanted
	IniWrite, %AfterFS%, settings.ini, settings, AfterFS
	IniWrite, %AfterWU%, settings.ini, settings, AfterWU
	IniWrite, %logging%, settings.ini, settings, LoggingLockTimes

	idleseconds:=1000*(seconds)
	FadeOut(ProtectionSettings)
	RSNotify("Applied")
	IniWrite, %seconds%, settings.ini, settings, seconds
	If BreakLoop=1
		Gosub Protection
	If (lockkey!="None" && lockkey!="" and lockkey!=keysvar)
		Hotkey, %lockkey%, Off
	GoSub LockLabel
return

;--------------------------------------------------------------------------------------------------------------

ScriptFunctions:
		Width := 300
		Gui, Functions:New, +hwndSFunctions
		Gui, +LastFound
		WinSet, Transparent, 0
		Gui, Color, 008383
		Gui, Margin, 0, 0
		Gui, Font, s11 cD0D0D0 Bold
		Gui, Add, Progress, % "x-1 y-1 w" (Width+2) " h66 Background1F2326 Disabled hwndHPROG"
		Control, ExStyle, -0x20000, , ahk_id %HPROG% ; propably only needed on Win XP
		Gui, Add, Text, % "x0 y0 w" Width " h30 BackgroundTrans Center 0x200 gGuiMove vCaption", Functions
		Gui, Font, s8 c228a96, Tahoma
		Gui, Add, Text, % "x-2 y+2 w" (Width) " Center BackgroundTrans", The Lock key is configurable
		Gui, Add, Text, % "x-2 y+2 w" (Width) " Center BackgroundTrans", Check Protection Settings
		Gui, Font, s10 cD0D0D0, Tahoma
		Gui, Add, Text, % "x-2 y+10 w" (Width-(Width*0.47)) " Center BackgroundTrans", Function
		Gui, Add, Text, % "x+52 w30 Center BackgroundTrans", Keys
		Gui, Font, s8 cD0D0D0, Tahoma

		Gui, Add, Text, % "x0 y+0 w" Width " h3 Center ",
		Gui, Add, Text, % "x0 y+8 w" (Width/2) " Center ", Speed Dial
		Gui, Add, Text, % "x+1 w" (Width/2) " Center", F4

		Gui, Add, Text, % "x0 y+8 w" (Width/2) " Center ", Speed Dial a website
		Gui, Add, Text, % "x+1 w" (Width/2) " Center", F4 + 1/2/3...8

		Gui, Add, Text, % "x0 y+8 w" (Width/2) " Center ", Play/Pause:
		Gui, Add, Text, % "x+1 w" (Width/2) " Center", F9

		Gui, Add, Text, % "x0 y+8 w" (Width/2) " Center ", Previous:
		Gui, Add, Text, % "x+1 w" (Width/2) " Center", F11

		Gui, Add, Text, % "x0 y+8 w" (Width/2) " Center ", Next:
		Gui, Add, Text, % "x+1 w" (Width/2) " Center", F12

		Gui, Add, Text, % "x0 y+0 w" Width " h11 Center ",

		Gui, Add, Text, % "x3 y+6 w" (Width/2) " Center ", Minimize Current App:
		Gui, Add, Text, % "x+0 w" (Width/2) " Center",  Alt x 2

		Gui, Add, Text, % "x0 y+0 w" Width " h11 Center ",

		Gui, Add, Text, % "x0 y+6 w" (Width/2) " Center ", Volume Control:
		Gui, Add, Text, % "x+1 w" (Width/2) " Center", Scroll Over Tray

		Gui, Add, Text, % "x0 y+8 w" (Width/2) " Center ", Volume Up:
		Gui, Add, Text, % "x+1 w" (Width/2) " Center", Page Up

		Gui, Add, Text, % "x0 y+8 w" (Width/2) " Center ", Volume Down:
		Gui, Add, Text, % "x+1 w" (Width/2) " Center", Page Down

		Gui, Add, Text, % "x0 y+0 w" Width " h11 Center ",

		Gui, Add, Text, % "x0 y+12 w" (Width/2) " Center ", Lock Now:
		Gui, Add, Text, % "x+1 w" (Width/2) " Center", %keysvar%

		Gui, Add, Text, % "x0 y+8 w" (Width/2) " Center ", Input Email:
		Gui, Add, Text, % "x+1 w" (Width/2) " Center", CapsLock x 2

		Gui, Add, Text, % "x0 y+8 w" (Width/2) " Center ", Input Password:
		Gui, Add, Text, % "x+1 w" (Width/2) " Center", Win + CapsLock x 2

		Gui, Add, Text, % "x0 y+0 w" Width " h11 Center ",

		Gui, Add, Text, % "x0 y+8 w" (Width/2) " Center ", Reload Script:
		Gui, Add, Text, % "x+1 w" (Width/2) " Center", Win + Alt + R

		Gui, Add, Text, % "x0 y+8 w" (Width/2) " Center ", Suspend Script:
		Gui, Add, Text, % "x+1 w" (Width/2) " Center", Win + Alt + S

		Gui, Font, s10 cFFFFFF Bold, Segoe UI
		Opt1 := [6, 0x008383, 0x008383, 0xEEEEEE]
		Opt2 := [ , 0x008383, 0x00a3a3, 0xffffff]
		Opt4 := [0, 0xC0A0A0A0, , 0xC0606000]

		Gui, Add, Button, % "x" (Width/2)-((Width*0.64)/2) " y+12 w" (Width*0.64) " h37 gPrInfo hwndBut1 +Center", RS-Guard Info

		Gui, Add, Button, % "x" (Width/2)-((Width*0.35)/2) " w" (Width*0.35) " y+12 gsubit +hwndBut2 +Default", Exit

		Gui, Add, Text, % "x7 y+2 w" (Width-14) "h2 vP"
		GuiControlGet, P, Pos
		H := PY + PH
		H:=H*dpi
		Width:=Width*dpi
		ImageButton.Create(But1, Opt1, Opt2, "", Opt4)
		ImageButton.Create(But2, Opt1, Opt2, "", Opt4)
		Gui, -Caption
		WinSet, Region, 0-0 w%Width% h%H% r6-6
		Gui, Show, % "w" Width " NA", Functions
		FadeIn(SFunctions)
return

subit:
FadeOut(SFunctions)
 	Gui, Submit, NoHide
return

;--------------------------------------------------------------------------------------------------------------

MenuInit:
IfExist RSIcon.ico
{
	Menu, Tray, Icon
	Menu, TRAY, Icon, RSIcon.ico
}
Else
{
	FileInstall, Base/RSIcon.ico, %A_MyDocuments%\%ScriptName%\RSIcon.ico, 1
	Menu, Tray, Icon
	Menu, TRAY, Icon, RSIcon.ico
}
If A_IsCompiled
Menu, Tray, Tip, %ScriptName%
Else
Menu, Tray, Tip, %ScriptName% Uncompiled
Menu, Tray, NoStandard
Menu, Tray, ADD, Menu, DefaultMenu
Menu, Tray, ADD, Reload, mnuScriptReload
Menu, Tray, ADD, Quit, mnuExit
Menu, Tray, Default, Menu
Menu Tray, Click, 1           ; Enable single click action on tray
Return

mnuScriptReload:
	IntentReload=1
	Reload
Return

mnuUninstall:
	FadeOut(ScriptOptionsFirst)
	FadeOut(DefaultHWND)
	FadeOut(ScriptOptions)
	RSNotify("Uninstalling")
	Loop, Files, *.ahk
	{
		SplitPath, A_LoopFileLongPath,,,, PluginName
		IfWinExist, % "ahk_pid" PID%PluginName%
			WinKill, % "ahk_pid" PID%PluginName%
	}
	Sleep 2000
	SplitPath, A_Scriptname, , , , OutNameNoExt
	LinkFile=%A_Startup%\%OutNameNoExt%.lnk
	StartMenuFile=%A_StartMenu%\Programs\devRS.lnk
	FileDelete, %StartMenuFile%
	FileDelete, %LinkFile%
	Run, %comspec% /c SchTasks /F /Delete /TN RSRunScript, , HIDE
	FileInstall, Base\uninstaller.exe, %A_Temp%\uninstaller.exe, 1
	Run, %A_Temp%\uninstaller.exe,, HIDE
	ExitApp
return

SuspendScriptToggle:
Suspend, Toggle
Loop, Files, *.ahk
{
	SplitPath, A_LoopFileLongPath,,,, PluginName
	IfWinExist, % "ahk_pid" PID%PluginName%
		PostMessage, 0x111, 65305,,, %PluginName%.ahk - AutoHotkey ; Suspend plugins.
}
If A_IsSuspended
{
	Menu, Tray, Icon
	Menu, TRAY, Icon, RSStopped.ico,,1
	RSNotify("Suspended")
	If A_IsPaused
		Pause, Off
	IniWrite, Suspended, settings.ini, plugins, State
}
If !A_IsSuspended
{
	Menu, Tray, Icon
	Menu, TRAY, Icon, RSIcon.ico,,1
	RSNotify("Released")
	If A_IsPaused
		Pause, Off
}
return

mnuExit:
	FadeOut(DefaultHWND)
	GoSub RSRunScript
	sleep 1000
	GoSub ExitAppL
Return

ExitAppL:
	If IntentReload=1
		IniWrite, %IntentReload%, settings.ini, settings, Reloaded
	Loop, Files, *.ahk
	{
		SplitPath, A_LoopFileLongPath,,,, PluginName
		IfWinExist, % "ahk_pid" PID%PluginName%
			WinKill, % "ahk_pid" PID%PluginName%
	}
	ExitApp
return

DefaultMenu:
	if(!DefaultFader)
	{
		FadeOut(DefaultHWND)
		Gui, DefaultMenu:New, +hwndDefaultHWND
		Gui, +LastFound +AlwaysOnTop -Caption +ToolWindow
		WinSet, Transparent, 0
		Gui, Margin, 0, 0
		Gui, Font,  cFFFFFF Bold, Segoe UI
		Gui, Color, 232323

		If (A_ScreenWidth<2000)
		{
			amultiplier=1
			zfont=13
		}
		If (A_ScreenWidth<1800)
		{
			amultiplier=1
			zfont=12
		}
		If (A_ScreenWidth<1600)
		{
			amultiplier=0.92
			zfont=11
		}
		If (A_ScreenWidth<1400)
		{
			amultiplier=0.87
			zfont=11
		}
		If (A_ScreenWidth<1050)
		{
			amultiplier=0.80
			zfont=10
		}

		Gui, Font, s%zfont% cFFFFFF Bold q5
			guiw:=880*amultiplier
			guih:=56*amultiplier
			buth:=(guih)+2
			butw:=((guiw-30)/8)
			guipos:=A_ScreenHeight-164

		Opt1 := [6, 0x232323, 0x232323, "White"]
		Opt2 := [ , 0x292929, 0x282828, 0xffffff]
		Opt4 := [0, 0xC0A0A0A0, , 0xC0606000]

		Gui, Add, Button, % "x0 y-2 h" buth " w" butw+9 " gProtectSwitch hwndBut1 +Center", Protection

		Gui, Add, Button, % "x+0 h" buth " w" butw " gSuspendScriptToggle hwndBut2 +Center", Suspend

		Gui, Add, Button, % "x+0 h" buth " w" butw " gmnuScriptReload hwndBut3 +Center", Reload

		Gui, Add, Button, % "x+0 h" buth " w" butw " gLockNow hwndBut4 +Center",  Lock

		Gui, Add, Button, % "x+0 y-2 h" buth " w" butw+9 " gUpdate hwndBut5 +Center", Update

		Gui, Add, Button, % "x+0 h" buth " w" butw+7 " gScriptFunctions hwndBut6 +Center", Controls

		Gui, Add, Button, % "x+0 h" buth " w" butw " gsettings hwndBut7 +Center", Settings

		Gui, Add, Button, % "x+0 h" buth " w" butw-37 " gmnuExit hwndBut8 +Center",  Quit

		Gui, Add, Button, % "x+0 h" buth " w53 gExitDefMenu hwndBut9 ", ×
		guiw:=guiw*dpi
		guih:=guih*dpi
		ImageButton.Create(But1, Opt1, Opt2, "", Opt4)
		ImageButton.Create(But2, Opt1, Opt2, "", Opt4)
		ImageButton.Create(But3, Opt1, Opt2, "", Opt4)
		ImageButton.Create(But4, Opt1, Opt2, "", Opt4)
		ImageButton.Create(But5, Opt1, Opt2, "", Opt4)
		ImageButton.Create(But6, Opt1, Opt2, "", Opt4)
		ImageButton.Create(But7, Opt1, Opt2, "", Opt4)
		ImageButton.Create(But8, Opt1, Opt2, "", Opt4)
		ImageButton.Create(But9, Opt1, Opt2, "", Opt4)
		WinSet, Region, 0-0 w%guiw% h%guih% r50-50, ahk_id %DefaultHWND%
		guiw:=guiw/dpi
		guih:=guih/dpi
		Gui, Show, h%guih% w%guiw% y%guipos%, Menu
		FadeIn(DefaultHWND)

		IniRead, UpdateVersion, build_update.ini, build, Version, 1.0
		IniRead, InstalledVersion, build.ini, build, Version, 1.0
		IniRead, PromptVersion, build.ini, build, PromptVersion
		If % VersionCompare(UpdateVersion, InstalledVersion)=1
		{		
			If(PromptVersion!=UpdateVersion)
				GoSub UpdatePrompt
			else
				RSNotify("Update Available")
		}

		DefaultFader:=true
	}
Return

ExitDefMenu:
FadeOut(DefaultHWND)
DefaultFader:=false
return

;--------------------------------------------------------------------------------------------------------------

SecurityLoggingLabel:
	Array := Object()
	Loop, Read, log.txt ; This loop retrieves each line from the file, one at a time.
	{
		Array.Insert(A_LoopReadLine)
	}
	elcount:=Array.MaxIndex() ; get the count of the lines in the log file
	calccount:=elcount-20 ; get the index of the last 20

	Width :=330
	Gui, SecLogs:New, +hwndSecLogs
	Gui, +LastFound +ToolWindow
	WinSet, Transparent, 0
	Gui, Color, 2e2e2e
	Gui, Margin, 0, 0
	Gui, Font, s11 cFFFFFF Bold, Tahoma
	Gui, Add, Progress, % "x-1 y-1 w" (Width+2) " h31 Background2e2e2e Disabled hwndHPROG"
	Control, ExStyle, -0x20000, , ahk_id %HPROG% ; propably only needed on Win XP

	Loop, 20
	{
		element:=Array[calccount+A_Index]
		if(A_Index=1 and element="")
		continue
		Gui, Add, Text, % "x0 y+4 w" Width " r1 BackgroundTrans  Center 0x200 gGuiMove cD0D0D0", %element%
	}

	Gui, Color, 2e2e2e
	Gui, Font, s11 cFFFFFF Bold, Segoe UI

	Gui, Add, Button, % "x" (Width/2)-((Width*0.64)/2) " y+22 w" (Width*0.64) " gdestroySecLogs hwndBut1 +Center +Default", Close
	Opt1 := [6, 0x2e2e2e, 0x2e2e2e, "White"]
	Opt2 := [ , 0x2e2e2e, 0x444444, 0xffffff]
	Opt4 := [0, 0xC0A0A0A0, , 0xC0606000]

	Gui, Add, Text, % "x+1 h46 vP"
	GuiControlGet, P, Pos
	H := PY + PH
	H:=H*dpi
	Width:=Width*dpi
	ImageButton.Create(But1, Opt1, Opt2, "", Opt4)
	Gui, -Caption
	WinSet, Region, 0-0 w%Width% h%H% r12-12
	Gui, Show, % "w" Width  , Security Logs
	FadeIn(SecLogs)
return

destroySecLogs:
FadeOut(SecLogs)
return

;--------------------------------------------------------------------------------------------------------------

WarningGUI:
	Width :=220
	Gui, WarningGUI:New, +hwndWarningGUI
	Gui, +LastFound +ToolWindow
	WinSet, Transparent, 0
	Gui, Color, 2e2e2e
	Gui, Margin, 0, 0
	Gui, Font, s11 cRed Bold, Tahoma
	Gui, Add, Progress, % "x-1 y-1 w" (Width+2) " h31 Background2e2e2e Disabled hwndHPROG"
	Control, ExStyle, -0x20000, , ahk_id %HPROG% ; propably only needed on Win XP

	If(ProtectionWarning)
	{
		Gui, Add, Text, % "x0 y15 w" Width " r1 BackgroundTrans Center 0x200 gGuiFade", Protection : Error
		Gui, Font, s8 cFFFFFF Bold, Tahoma
		Gui, Add, Text, % "x0 y+20 w" Width " r1 BackgroundTrans Center 0x200 gGuiFade cD0D0D0", For the Protection to work:
		Gui, Add, Text, % "x0 y+0 w" Width " r1 BackgroundTrans Center 0x200 gGuiFade cD0D0D0 h5",
		ProtectionWarning=0
	}
	Gui, Font, s8 cFFFFFF Bold, Tahoma

	If(Warning)
		Gui, Add, Text, % "x0 y+5 w" Width " r1 BackgroundTrans Center 0x200 gGuiFade cD0D0D0", %Warning%

	Loop, 10
	If(Warning%A_Index%)
	{
		Gui, Add, Text, % "x0 y+6 w" Width " r1 BackgroundTrans Center 0x200 gGuiFade cD0D0D0", % Warning%A_Index%
		Warning%A_Index%=
	}

	Gui, Add, Text, % "x+1 h46 vP"
	GuiControlGet, P, Pos
	H := PY + PH
	H:=H*dpi
	Width:=Width*dpi
	Gui, -Caption
	WinSet, Region, 0-0 w%Width% h%H% r12-12
	Gui, Show, % "w" Width  , Warning
	FadeIn(WarningGUI)
	If(Warning) ; If it's just a simple warning (Warning variable is used)
	{
		SetTimer, FadeOutWarning, -1800
		Warning=
	}
	else ; If it's an important warning (Warning1-10 variables are used)
		SetTimer, FadeOutWarning, -8500

return

FadeOutWarning:
	FadeOut(WarningGUI)
return

;--------------------------------------------------------------------------------------------------------------

PrInfo:
	Width :=330
	Gui, PrInfo:New, +hwndPrInfo
	Gui, +LastFound +ToolWindow
	WinSet, Transparent, 0
	Gui, Color, 2e2e2e
	Gui, Margin, 0, 0
	Gui, Font, s11 cFFFFFF Bold, Tahoma
	Gui, Add, Progress, % "x-1 y-1 w" (Width+2) " h31 Background2e2e2e Disabled hwndHPROG"
	Control, ExStyle, -0x20000, , ahk_id %HPROG% ; propably only needed on Win XP
	Gui, Add, Text, % "x0 y16 w" Width " r1 BackgroundTrans Center 0x200 gGuiMove cD0D0D0", RS-Guard is designed to protect your PC.
	Gui, Add, Text, % "x0 y+4 w" Width " r1 BackgroundTrans  Center 0x200 gGuiMove cD0D0D0", It is going to lock the computer after
	Gui, Add, Text, % "x0 y+4 w" Width " r1 BackgroundTrans  Center 0x200 gGuiMove cD0D0D0", the amount of time you have set.
		Gui, Font, s11 cFFFFFF Bold, Tahoma
	Gui, Add, Text, % "x0 y+22 w" Width " r1 BackgroundTrans Center 0x200 gGuiMove cD0D0D0",  --- How to use it ---
		Gui, Font, s9 cFFFFFF Bold, Tahoma
	Gui, Add, Text, % "x0 y+4 w" Width " r1 BackgroundTrans Center 0x200 gGuiMove cD0D0D0",  Set a password.
	Gui, Add, Text, % "x0 y+4 w" Width " r1 BackgroundTrans Center 0x200 gGuiMove cD0D0D0",  Wait or press the lock button.
			Gui, Font, s11 cFFFFFF Bold, Tahoma
	Gui, Add, Text, % "x0 y+22 w" Width " r1 BackgroundTrans  Center 0x200 gGuiMove cD0D0D0", --- Requirements ---
		Gui, Font, s9 cFFFFFF Bold, Tahoma
	Gui, Add, Text, % "x0 y+4 w" Width " r1 BackgroundTrans  Center 0x200 gGuiMove cD0D0D0", The password needs to be a number.
	Gui, Add, Text, % "x0 y+4 w" Width " r1 BackgroundTrans  Center 0x200 gGuiMove cD0D0D0", You MUST set seconds and a password.
			Gui, Font, s11 cFFFFFF Bold, Tahoma
	Gui, Add, Text, % "x0 y+22 w" Width " r1 BackgroundTrans Center 0x200 gGuiMove cD0D0D0",  --- What some settings do ---
	Gui, Add, Text, % "x0 y+10 w" Width " r1 BackgroundTrans  Center 0x200 gGuiMove cD0D0D0", - Protected/Unprotected Dropdown -
			Gui, Font, s9 cFFFFFF Bold, Tahoma
	Gui, Add, Text, % "x0 y+4 w" Width " r1 BackgroundTrans  Center 0x200 gGuiMove cD0D0D0",  Toggles whether RS-Guard will lock the PC
	Gui, Add, Text, % "x0 y+4 w" Width " r1 BackgroundTrans  Center 0x200 gGuiMove cD0D0D0", after the amount of time or not.
	Gui, Add, Text, % "x0 y+4 w" Width " r1 BackgroundTrans  Center 0x200 gGuiMove cD0D0D0", You can still lock it with the select key
			Gui, Font, s11 cFFFFFF Bold, Tahoma
	Gui, Add, Text, % "x0 y+10 w" Width " r1 BackgroundTrans  Center 0x200 gGuiMove cD0D0D0", - Lock After Full Screen -
			Gui, Font, s9 cFFFFFF Bold, Tahoma
	Gui, Add, Text, % "x0 y+4 w" Width " r1 BackgroundTrans  Center 0x200 gGuiMove cD0D0D0", This option controls whether the PC
	Gui, Add, Text, % "x0 y+4 w" Width " r1 BackgroundTrans  Center 0x200 gGuiMove cD0D0D0", will lock itself after you exit full screen.
	Gui, Add, Text, % "x0 y+4 w" Width " r1 BackgroundTrans  Center 0x200 gGuiMove cD0D0D0", This is useful when you are watching a movie.
			Gui, Font, s11 cFFFFFF Bold, Tahoma
	Gui, Add, Text, % "x0 y+10 w" Width " r1 BackgroundTrans  Center 0x200 gGuiMove cD0D0D0", - Clock -
			Gui, Font, s9 cFFFFFF Bold, Tahoma
	Gui, Add, Text, % "x0 y+4 w" Width " r1 BackgroundTrans  Center 0x200 gGuiMove cD0D0D0", Controls whether a clock is displayed
	Gui, Add, Text, % "x0 y+4 w" Width " r1 BackgroundTrans  Center 0x200 gGuiMove cD0D0D0", on the lock screen.

		Gui, Color, 2e2e2e
		Gui, Font, s11 cFFFFFF Bold, Tahoma

	Gui, Add, Button, % "x" (Width/2)-((Width*0.64)/2) " y+18 w" (Width*0.64) " gdestroyPrInfo hwndBut1 +Center +Default", Got it
	Opt1 := [6, 0x2e2e2e, 0x2e2e2e, "White"]
	Opt2 := [ , 0x2e2e2e, 0x444444, 0xffffff]
	Opt4 := [0, 0xC0A0A0A0, , 0xC0606000]
	ImageButton.Create(But1, Opt1, Opt2, "", Opt4)

	Gui, Add, Text, % "x+1 h46 vP"
	GuiControlGet, P, Pos
	H := PY + PH
	H:=H*dpi
	Width:=Width*dpi
	Gui, -Caption
	WinSet, Region, 0-0 w%Width% h%H% r12-12
	Gui, Show, % "w" Width  , RS-Guard Settings
	FadeIn(PrInfo)

return

destroyPrInfo:
	FadeOut(PrInfo)
return

;--------------------------------------------------------------------------------------------------------------

AdminPrompt:
	width=135
	height=66
	Gui, AdminPrompt:New, +hwndAdminPrompt
	Gui, +LastFound
	WinSet, Transparent, 0
	Gui, Margin, 0, 0
	Gui, -Caption
	Gui, Color, 008383
	Gui, Font, s10 Bold, Tahoma
	Opt1 := [6, 0x008383, 0x008383, "White"]
	Opt2 := [ , 0x008383, 0x00a3a3, 0xffffff]
	Opt4 := [0, 0xC0A0A0A0, , 0xC0606000]
	Gui, Add, Progress, % "x-1 y-1 w" width " h26 Background1F2326 Disabled hwndHPROG"
	Control, ExStyle, -0x20000, , ahk_id %HPROG% ; propably only needed on Win XP
	Gui, Add, Text, x0 y4 w%width% Center BackgroundTrans +0x200 c228a96, Are you an admin?
	Gui, Add, Button, x8 y30 w55 +default gRunAsAdmin hwndBut1 +Center, Yeah
	ImageButton.Create(But1, Opt1, Opt2, "", Opt4)

	Gui, Add, Button, x71 y30 w55 gNotAnAdmin hwndBut2 +Center,Nope
	ImageButton.Create(But2, Opt1, Opt2, "", Opt4)

	width:=width*dpi
	height:=height*dpi
	WinSet, Region, 0-0 w%width% h%height% r3-3, ahk_id %AdminPrompt%
	Gui, Show, w%width% h%height% , Are you an admin?
	FadeIn(AdminPrompt)
return

;--------------------------------------------------------------------------------------------------------------

Authorization:
	Gui, Auth:New, +hwndAuth
	Gui, +LastFound +ToolWindow +AlwaysOnTop
	WinSet, Transparent, 0
	Gui, Margin, 0, 0
	Gui, -Caption
	Gui, Color, 333333, 333333
	Gui, Font, s10 Bold c00afaf, Tahoma
	Gui, Add, Progress, % "x-1 y-1 w200 h26 Background1f1f1f Disabled hwndHPROG"
	Control, ExStyle, -0x20000, , ahk_id %HPROG% ; propably only needed on Win XP
	Gui, Add, Text, x0 y4 w200 Center BackgroundTrans +0x200 cb1b1b1, Please authorize yourself.

	Gui, Font, w700 s12 c00afaf, Segoe UI Black
	Gui, Add, Edit, % "x0 y+13 w155 h25 hwndEdit265 vorigpass -E0x200 +Center -VScroll +password",

	
	Gui, Font, w700 s11 ceeeeee, Segoe UI Black
	Opt1 := [6, 0x333333, 0x333333, 0xD0D0D0]
	Opt2 := [ , 0x333333, 0x333333, 0xffffff]
	Opt4 := [0, 0xC0A0A0A0, , 0xC0606000]

	Gui, Add, Button, x+0 w45 h25 +default gAuthorize hwndBut1 +Center, Go
	ImageButton.Create(But1, Opt1, Opt2, "", Opt4)

	scaledw:=200*dpi
	scaledh:=70*dpi
	SHAutoComplete(Edit265)
	WinSet, Region, 0-0 w%scaledw% h%scaledh% r12-12, ahk_id %Auth%
	Gui, Show, w%scaledw% h%scaledh%, Authorization
	FadeIn(Auth)
return

Authorize:
	Gui, Submit, NoHide
	If (origpass=password and StrLen(origpass)>0)
	{
		Authorized:=true
		RSNotify("Authorized")
		FadeOut(Auth)
		WinWaitNotActive, ahk_id %Auth%,,15
		SendInput {Raw}%password%
		SetTimer, AuthExpirationCheck, 2000
		StartTick:=A_TickCount
		return
	}
	Else
		RSNotify("Not Authorized")
	FadeOut(Auth)
return

AuthExpirationCheck:
	If (A_TimeIdle > 360000) or (A_TickCount - StartTick > 7500) ; Authorization will expire when computer goes to sleep or when idle for 6 minutes.
	{
		Authorized:=false
		SetTimer, AuthExpirationCheck, Off
	}
	StartTick:=A_TickCount
return

AuthExpire:
	Authorized:=false
	SetTimer, AuthExpirationCheck, Off
return

AuthGuiEscape:
	FadeOut(Auth)
return

;--------------------------------------------------------------------------------------------------------------

UpdatePrompt:
	width=135
	height=66
	Gui, UpdatePrompt:New, +hwndUpdatePrompt
	Gui, +LastFound +ToolWindow
	WinSet, Transparent, 0
	Gui, Margin, 0, 0
	Gui, -Caption
	Gui, Color, 008383
	Gui, Font, s10 Bold, Tahoma
	Opt1 := [6, 0x008383, 0x008383, "White"]
	Opt2 := [ , 0x008383, 0x00a3a3, 0xffffff]
	Opt4 := [0, 0xC0A0A0A0, , 0xC0606000]
	Gui, Add, Progress, % "x-1 y-1 w" width " h26 Background1F2326 Disabled hwndHPROG"
	Control, ExStyle, -0x20000, , ahk_id %HPROG% ; propably only needed on Win XP
	Gui, Add, Text, x0 y4 w%width% Center BackgroundTrans +0x200 c228a96, Update to v%UpdateVersion%?
	Gui, Add, Button, x8 y30 w55 +default gUpdate hwndBut1 +Center, Yeah

	Gui, Add, Button, x71 y30 w55 gNoUpdate hwndBut2 +Center,Nope

	width:=width*dpi
	height:=height*dpi
	ImageButton.Create(But1, Opt1, Opt2, "", Opt4)
	ImageButton.Create(But2, Opt1, Opt2, "", Opt4)
	WinSet, Region, 0-0 w%width% h%height% r3-3, ahk_id %UpdatePrompt%
	Gui, Show, w%width% h%height% , Update Prompt
	FadeIn(UpdatePrompt)
return

;--------------------------------------------------------------------------------------------------------------